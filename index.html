<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Elite Méretező PRO v1.1</title>
    <style>
        :root { --accent: #30d158; --bg: #000; --box-bg: rgba(48, 209, 88, 0.1); }
        
        /* BETONBIZTOS FRISSÍTÉSGÁTLÁS ÉS FIXÁLÁS */
        html, body { 
            overscroll-behavior: none !important; overflow: hidden !important;
            position: fixed; width: 100vw; height: 100vh; margin: 0; padding: 0;
            background: var(--bg); color: #fff; font-family: sans-serif; 
            touch-action: none !important; -webkit-user-select: none; user-select: none;
        }

        #barrier { position: fixed; top: 0; left: 0; width: 100%; height: 10px; z-index: 10000; background: transparent; }
        #overlay { position: fixed; inset: 0; background: #000; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        
        /* KALIBRÁCIÓS FELÜLET */
        .setup-input { background: #1a1a1a; border: 1px solid var(--accent); color: #fff; padding: 10px; border-radius: 8px; width: 180px; margin: 10px; text-align: center; font-size: 16px; }
        #cal-area { position: relative; margin: 25px 0; height: 100px; display: flex; align-items: center; justify-content: center; width: 100%; max-width: 400px; }
        #cal-main-line { height: 2px; background: #fff; width: 200px; position: relative; }
        .cal-v-left { position: absolute; left: 0; top: -35px; width: 2px; height: 70px; background: #fff; }
        .cal-v-right { position: absolute; right: 0; top: -35px; width: 3px; height: 70px; background: var(--accent); }
        #cal-handle { position: absolute; right: -25px; top: -45px; width: 60px; height: 90px; z-index: 50; touch-action: none; background: transparent; cursor: ew-resize; }

        .cal-type-btn { background: #222; color: #fff; border: 1px solid #444; padding: 12px; border-radius: 8px; flex: 1; font-size: 14px; pointer-events: auto; }
        .cal-type-btn.active { border-color: var(--accent); background: var(--box-bg); }
        .adj-btn { background: #333; color: white; border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 24px; display: flex; align-items: center; justify-content: center; pointer-events: auto; }
        
        .fix-btn { background: #111; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 8px; width: 145px; font-weight: bold; pointer-events: auto; }
        .fix-btn.active { border-color: var(--accent); background: var(--box-bg); color: var(--accent); }

        #login-screen { text-align: center; }
        #saved-btn { background: #111; border: 2px solid var(--accent); color: #fff; padding: 25px; border-radius: 15px; width: 280px; margin-bottom: 20px; text-align: center; cursor: pointer; }
        
        /* MUNKATERÜLET */
        #canvas { display: none; width: 100%; height: 100%; position: relative; }
        #box { position: absolute; top: 100px; left: 100px; border: 2px solid var(--accent); background: var(--box-bg); box-sizing: border-box; }
        .handle { width: 32px; height: 32px; border-radius: 50%; position: absolute; z-index: 20; border: 2px solid #000; touch-action: none !important; }
        #move-handle { top: -16px; left: -16px; background: #fff; }
        #resize-handle { bottom: -16px; right: -16px; background: var(--accent); }
        
        #controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; background: rgba(25,25,25,0.98); padding: 10px; border-radius: 12px; border: 1px solid #444; align-items: center; z-index: 100; pointer-events: auto; }
        .m-input { background: #000; border: 1px solid #555; color: #fff; padding: 8px; border-radius: 5px; width: 55px; text-align: center; }
        .f-btn { background: #333; color: #fff; border: none; padding: 10px 14px; border-radius: 5px; font-weight: bold; }
        .ok-btn { background: var(--accent); border: none; padding: 10px 15px; border-radius: 6px; font-weight: bold; color: #000; }
        
        .label-w { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 14px; color: var(--accent); font-weight: bold; white-space: nowrap; }
        .label-h { position: absolute; left: -80px; top: 50%; transform: translateY(-50%) rotate(-90deg); font-size: 14px; color: var(--accent); font-weight: bold; width: 140px; text-align: center; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="barrier"></div>

<div id="overlay">
    <div id="login-screen" style="display:none;">
        <div id="saved-btn" onclick="initApp()">
            <div id="s-name" style="font-weight:bold; font-size:22px;"></div>
            <div style="color:var(--accent); font-size:16px; margin-top:5px;">Dupla kalibráció aktív</div>
        </div>
        <button onclick="showRegister()" style="background:none; border:1px solid #444; color:#888; padding:10px; border-radius:8px;">Új kalibrálás</button>
    </div>

    <div id="register-screen" style="text-align:center;">
        <h3 style="color:var(--accent); margin-bottom:15px;">Kalibrálás (Álló + Fekvő)</h3>
        
        <div style="display: flex; gap: 10px; width: 320px; margin: 0 auto 15px;">
            <button id="btn-card" class="cal-type-btn active" onclick="setCalType('card')">Személyi (85.6)</button>
            <button id="btn-cash" class="cal-type-btn" onclick="setCalType('cash')">Pénz (70)</button>
        </div>

        <div id="cal-area">
            <div id="cal-main-line">
                <div class="cal-v-left"></div>
                <div class="cal-v-right"></div>
                <div id="cal-handle"></div>
            </div>
        </div>

        <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px;">
            <button class="adj-btn" onclick="adjCal(-1)">-</button>
            <input type="number" id="calRef" class="setup-input" style="width: 80px; margin: 0;" value="85.6" readonly>
            <button class="adj-btn" onclick="adjCal(1)">+</button>
        </div>

        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;">
            <button id="fix-port" class="fix-btn" onclick="lockValue('port')">RÖGZÍT: ÁLLÓ</button>
            <button id="fix-land" class="fix-btn" onclick="lockValue('land')">RÖGZÍT: FEKVŐ</button>
        </div>

        <input type="text" id="devName" class="setup-input" value="Samsung Eszköz">
        <br>
        <button id="save-main" onclick="doCalibrate()" style="background:#222; border:1px solid #444; padding:15px 40px; border-radius:10px; font-weight:bold; color:#555; margin-top:10px; pointer-events: auto;">MENTÉS</button>
    </div>
</div>

<div id="canvas">
    <div id="box" style="width:150px; height:100px;">
        <div id="move-handle" class="handle"></div>
        <div id="label-w" class="label-w">0 mm</div>
        <div id="label-h" class="label-h">0 mm</div>
        <div id="resize-handle" class="handle"></div>
    </div>
    <div id="controls">
        <button class="f-btn" onclick="adj('w',-0.1)">-</button>
        <input type="number" id="m-w" class="m-input" inputmode="decimal">
        <button class="f-btn" onclick="adj('w',0.1)">+</button>
        <span style="width:10px"></span>
        <button class="f-btn" onclick="adj('h',-0.1)">-</button>
        <input type="number" id="m-h" class="m-input" inputmode="decimal">
        <button class="f-btn" onclick="adj('h',0.1)">+</button>
        <button onclick="setManual()" class="ok-btn">OK</button>
    </div>
</div>

<script>
    let activeAction = null;
    let startX, startW;
    let temp_port = null, temp_land = null;
    let currentPpmm = 1;

    const calMainLine = document.getElementById('cal-main-line');
    const calHandle = document.getElementById('cal-handle');

    // --- SZIGORÚ FRISSÍTÉSGÁTLÁS ---
    window.addEventListener('touchmove', (e) => { 
        if (!activeAction) e.preventDefault(); 
    }, { passive: false });

    document.addEventListener('touchstart', (e) => {
        if (e.target.closest('button, input, .handle, #saved-btn, #cal-handle')) return;
        if (e.touches.length > 1) e.preventDefault();
        e.preventDefault();
    }, { passive: false });

    // --- KALIBRÁCIÓS LOGIKA ---
    calHandle.addEventListener('pointerdown', (e) => {
        activeAction = 'cal';
        startX = e.clientX;
        startW = calMainLine.offsetWidth;
        calHandle.setPointerCapture(e.pointerId);
    });

    window.onload = () => {
        const draft = JSON.parse(localStorage.getItem('elite_draft_v11') || '{}');
        if(draft.port) { temp_port = draft.port; updateUI('port'); }
        if(draft.land) { temp_land = draft.land; updateUI('land'); }

        const saved = localStorage.getItem('elite_v11_final');
        if (saved) {
            const d = JSON.parse(saved);
            document.getElementById('s-name').innerText = d.name;
            document.getElementById('login-screen').style.display = 'block';
            document.getElementById('register-screen').style.display = 'none';
        }
        checkReady();
    };

    function setCalType(type) {
        document.getElementById('btn-card').classList.toggle('active', type === 'card');
        document.getElementById('btn-cash').classList.toggle('active', type === 'cash');
        document.getElementById('calRef').value = type === 'card' ? "85.6" : "70.0";
    }

    function adjCal(val) { calMainLine.style.width = Math.max(20, calMainLine.offsetWidth + val) + "px"; }

    function lockValue(o) {
        const val = calMainLine.offsetWidth / parseFloat(document.getElementById('calRef').value);
        const draft = JSON.parse(localStorage.getItem('elite_draft_v11') || '{}');
        if(o === 'port') { temp_port = val; draft.port = val; }
        else { temp_land = val; draft.land = val; }
        localStorage.setItem('elite_draft_v11', JSON.stringify(draft));
        updateUI(o);
        checkReady();
    }

    function updateUI(o) {
        const b = document.getElementById('fix-' + o);
        b.classList.add('active');
        b.innerText = o === 'port' ? "ÁLLÓ KÉSZ" : "FEKVŐ KÉSZ";
    }

    function checkReady() {
        if(temp_port && temp_land) {
            const btn = document.getElementById('save-main');
            btn.style.background = "var(--accent)";
            btn.style.color = "#000";
            btn.style.border = "none";
        }
    }

    function doCalibrate() {
        if(!temp_port || !temp_land) { alert("Rögzítse mindkét irányt!"); return; }
        const name = document.getElementById('devName').value || "Eszköz";
        localStorage.setItem('elite_v11_final', JSON.stringify({name: name, port: temp_port, land: temp_land}));
        localStorage.removeItem('elite_draft_v11');
        location.reload();
    }

    function initApp() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('canvas').style.display = 'block';
        updateLabel();
    }

    // --- MÉRÉS ÉS MOZGATÁS ---
    const box = document.getElementById('box');
    let bStartX, bStartY, bStartW, bStartH, bStartLeft, bStartTop;

    const handleStart = (e, type) => {
        activeAction = type; bStartX = e.clientX; bStartY = e.clientY;
        bStartW = box.offsetWidth; bStartH = box.offsetHeight;
        bStartLeft = box.offsetLeft; bStartTop = box.offsetTop;
        e.target.setPointerCapture(e.pointerId);
    };

    document.getElementById('move-handle').addEventListener('pointerdown', (e) => handleStart(e, 'move'));
    document.getElementById('resize-handle').addEventListener('pointerdown', (e) => handleStart(e, 'resize'));

    window.addEventListener('pointermove', (e) => {
        if (!activeAction) return;
        if (activeAction === 'cal') {
            calMainLine.style.width = Math.max(20, startW + (e.clientX - startX)) + "px";
        } else if (activeAction === 'move') {
            box.style.left = (bStartLeft + (e.clientX - bStartX)) + "px";
            box.style.top = (bStartTop + (e.clientY - bStartY)) + "px";
        } else if (activeAction === 'resize') {
            box.style.width = Math.max(20, bStartW + (e.clientX - bStartX)) + "px";
            box.style.height = Math.max(20, bStartH + (e.clientY - bSY ?? (e.clientY - bStartY))) + "px"; // Fix a Note 20-hoz
            box.style.height = Math.max(20, bStartH + (e.clientY - bStartY)) + "px";
        }
        updateLabel();
    });

    window.addEventListener('pointerup', () => { activeAction = null; });

    function updateLabel() {
        const saved = JSON.parse(localStorage.getItem('elite_v11_final'));
        if(!saved) return;
        currentPpmm = window.innerHeight > window.innerWidth ? saved.port : saved.land;
        const w = (box.offsetWidth / currentPpmm).toFixed(1);
        const h = (box.offsetHeight / currentPpmm).toFixed(1);
        document.getElementById('label-w').innerText = w + " mm";
        document.getElementById('label-h').innerText = h + " mm";
        document.getElementById('m-w').value = w;
        document.getElementById('m-h').value = h;
    }

    function adj(t, v) {
        if (t === 'w') box.style.width = (box.offsetWidth + (v * currentPpmm)) + "px";
        else box.style.height = (box.offsetHeight + (v * currentPpmm)) + "px";
        updateLabel();
    }

    function setManual() {
        const w = document.getElementById('m-w').value;
        const h = document.getElementById('m-h').value;
        if(w) box.style.width = (w * currentPpmm) + "px";
        if(h) box.style.height = (h * currentPpmm) + "px";
        updateLabel();
    }
    function showRegister() { localStorage.removeItem('elite_v11_final'); location.reload(); }
</script>
</body>
</html>
